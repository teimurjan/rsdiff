#!/bin/sh
set -eu

# Resolve repo base once
basedir=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)

# Optional: respect a one-time override (set it in your parent script or env)
if [ "${ODIFF_BIN:-}" ]; then
  exec "$ODIFF_BIN" "$@"
fi

# Cache location for the resolved binary (per checkout)
cache="$basedir/.odiff-bin-path"

if [ -f "$cache" ] && [ -x "$(cat "$cache")" ]; then
  exec "$(cat "$cache")" "$@"
fi

# One-time resolution (super cheap, no env gymnastics)
PLATFORM=$(uname -s)
ARCH=$(uname -m)

case "$PLATFORM:$ARCH" in
  Darwin:arm64) bin="$basedir/../odiff-bin/bin/odiff-darwin-arm64" ;;
  Darwin:x86_64) bin="$basedir/../odiff-bin/bin/odiff-darwin-x64" ;;
  Linux:aarch64|Linux:arm64) bin="$basedir/../odiff-bin/bin/odiff-linux-arm64" ;;
  Linux:x86_64|Linux:amd64) bin="$basedir/../odiff-bin/bin/odiff-linux-x64" ;;
  MINGW*:*|MSYS*:*|CYGWIN*:*) bin="$basedir/../odiff-bin/bin/odiff.exe" ;;
  *) echo "Unsupported platform: $PLATFORM $ARCH" >&2; exit 1 ;;
esac

[ -x "$bin" ] || { echo "Binary not executable: $bin" >&2; exit 1; }

# Cache for future runs
printf '%s' "$bin" > "$cache"

# Important: replace shell with the binary
exec "$bin" "$@"