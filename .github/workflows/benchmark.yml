name: Benchmark Tools

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      run_all_tools:
        description: "Run benchmarks for all tools"
        required: false
        default: true
        type: boolean
      run_rsdiff:
        description: "Run rsdiff benchmarks only"
        required: false
        default: false
        type: boolean
      run_odiff:
        description: "Run odiff benchmarks only"
        required: false
        default: false
        type: boolean
      run_pixelmatch:
        description: "Run pixelmatch benchmarks only"
        required: false
        default: false
        type: boolean

env:
  BENCHMARK_OUTPUTS_DIR: ${{ github.workspace }}/benchmark-outputs
  IMAGES_DIR: ${{ github.workspace }}/images

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      image-pairs: ${{ steps.find-pairs.outputs.pairs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find image pairs
        id: find-pairs
        run: |
          # Find image pairs for comparison
          IMAGE_PAIRS=()
          for img1 in "$IMAGES_DIR"/*.png "$IMAGES_DIR"/*.jpg; do
            if [[ -f "$img1" ]]; then
              base_name=$(basename "$img1" | sed 's/\.[^.]*$//')
              # Look for corresponding image with -1 suffix
              img2="$IMAGES_DIR/${base_name%-1}.png"
              if [[ -f "$img2" && "$img1" != "$img2" ]]; then
                # Use pipe separator instead of colon to avoid issues
                IMAGE_PAIRS+=("$img1|$img2")
              fi
            fi
          done

          if [ ${#IMAGE_PAIRS[@]} -eq 0 ]; then
            echo "No image pairs found. Looking for any two images..."
            # Fallback: use first two images
            IMAGES=($(ls "$IMAGES_DIR"/*.png "$IMAGES_DIR"/*.jpg 2>/dev/null | head -2))
            if [ ${#IMAGES[@]} -ge 2 ]; then
              IMAGE_PAIRS+=("${IMAGES[0]}|${IMAGES[1]}")
            fi
          fi

          echo "Found ${#IMAGE_PAIRS[@]} image pair(s):"
          for pair in "${IMAGE_PAIRS[@]}"; do
            echo "   $(basename "${pair%|*}") ‚Üî $(basename "${pair#*|}")"
          done

          # Convert to JSON array for GitHub Actions - ensure proper escaping
          if [ ${#IMAGE_PAIRS[@]} -gt 0 ]; then
            pairs_json="["
            for i in "${!IMAGE_PAIRS[@]}"; do
              if [ $i -gt 0 ]; then pairs_json+=","; fi
              # Properly escape the pipe-separated pair for JSON
              pairs_json+="\"${IMAGE_PAIRS[$i]}\""
            done
            pairs_json+="]"
          else
            pairs_json="[]"
          fi

          echo "Generated JSON: $pairs_json"
          echo "pairs=$pairs_json" >> $GITHUB_OUTPUT

      - name: Install jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

  benchmark-rsdiff:
    needs: setup
    if: ${{ inputs.run_all_tools == true || inputs.run_rsdiff == true || (inputs.run_all_tools != false && inputs.run_rsdiff != true && inputs.run_odiff != true && inputs.run_pixelmatch != true) }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image-pair: ${{ fromJson(needs.setup.outputs.image-pairs) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build rsdiff
        run: |
          cargo build --release
          sudo cp target/release/rsdiff /usr/local/bin/

      - name: Install hyperfine
        run: |
          curl -L https://github.com/sharkdp/hyperfine/releases/latest/download/hyperfine-x86_64-unknown-linux-musl.tar.gz | tar -xz
          sudo mv hyperfine /usr/local/bin/

      - name: Create benchmark outputs directory
        run: mkdir -p "$BENCHMARK_OUTPUTS_DIR"

      - name: Run rsdiff benchmark
        run: |
          PAIR="${{ matrix.image-pair }}"
          img1="${PAIR%|*}"
          img2="${PAIR#*|}"
          pair_name="$(basename "${img1%.*}")_vs_$(basename "${img2%.*}")"

          echo "üèÉ Running rsdiff benchmark for: $pair_name"

          hyperfine -i \
            --warmup 3 \
            --min-runs 50 \
            --max-runs 100 \
            --export-json "${BENCHMARK_OUTPUTS_DIR}/rsdiff_${pair_name}.json" \
            --export-markdown "${BENCHMARK_OUTPUTS_DIR}/rsdiff_${pair_name}.md" \
            "rsdiff \"$img1\" \"$img2\" --output rsdiff_${pair_name}_diff.png"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: rsdiff-benchmark-${{ strategy.job-index }}
          path: |
            ${{ env.BENCHMARK_OUTPUTS_DIR }}/rsdiff_*.json
            ${{ env.BENCHMARK_OUTPUTS_DIR }}/rsdiff_*.md
            rsdiff_*_diff.png

  benchmark-odiff:
    needs: setup
    if: ${{ inputs.run_all_tools == true || inputs.run_odiff == true || (inputs.run_all_tools != false && inputs.run_rsdiff != true && inputs.run_odiff != true && inputs.run_pixelmatch != true) }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image-pair: ${{ fromJson(needs.setup.outputs.image-pairs) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install

      - name: Install hyperfine
        run: |
          curl -L https://github.com/sharkdp/hyperfine/releases/latest/download/hyperfine-x86_64-unknown-linux-musl.tar.gz | tar -xz
          sudo mv hyperfine /usr/local/bin/

      - name: Create benchmark outputs directory
        run: mkdir -p "$BENCHMARK_OUTPUTS_DIR"

      - name: Run odiff benchmark
        run: |
          PAIR="${{ matrix.image-pair }}"
          img1="${PAIR%|*}"
          img2="${PAIR#*|}"
          pair_name="$(basename "${img1%.*}")_vs_$(basename "${img2%.*}")"

          echo "üèÉ Running odiff benchmark for: $pair_name"

          hyperfine -i \
            --warmup 3 \
            --min-runs 50 \
            --max-runs 100 \
            --export-json "${BENCHMARK_OUTPUTS_DIR}/odiff_${pair_name}.json" \
            --export-markdown "${BENCHMARK_OUTPUTS_DIR}/odiff_${pair_name}.md" \
            "node_modules/.bin/odiff --fail-on-layout=false \"$img1\" \"$img2\" odiff_${pair_name}_diff.png"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: odiff-benchmark-${{ strategy.job-index }}
          path: |
            ${{ env.BENCHMARK_OUTPUTS_DIR }}/odiff_*.json
            ${{ env.BENCHMARK_OUTPUTS_DIR }}/odiff_*.md
            odiff_*_diff.png

  benchmark-pixelmatch:
    needs: setup
    if: ${{ inputs.run_all_tools == true || inputs.run_pixelmatch == true || (inputs.run_all_tools != false && inputs.run_rsdiff != true && inputs.run_odiff != true && inputs.run_pixelmatch != true) }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image-pair: ${{ fromJson(needs.setup.outputs.image-pairs) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Install hyperfine
        run: |
          curl -L https://github.com/sharkdp/hyperfine/releases/latest/download/hyperfine-x86_64-unknown-linux-musl.tar.gz | tar -xz
          sudo mv hyperfine /usr/local/bin/

      - name: Create benchmark outputs directory
        run: mkdir -p "$BENCHMARK_OUTPUTS_DIR"

      - name: Run pixelmatch benchmark
        run: |
          PAIR="${{ matrix.image-pair }}"
          img1="${PAIR%|*}"
          img2="${PAIR#*|}"
          pair_name="$(basename "${img1%.*}")_vs_$(basename "${img2%.*}")"

          echo "üèÉ Running pixelmatch benchmark for: $pair_name"

          hyperfine -i \
            --warmup 3 \
            --min-runs 50 \
            --max-runs 100 \
            --export-json "${BENCHMARK_OUTPUTS_DIR}/pixelmatch_${pair_name}.json" \
            --export-markdown "${BENCHMARK_OUTPUTS_DIR}/pixelmatch_${pair_name}.md" \
            "node_modules/.bin/pixelmatch \"$img1\" \"$img2\" --output pixelmatch_${pair_name}_diff.png"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: pixelmatch-benchmark-${{ strategy.job-index }}
          path: |
            ${{ env.BENCHMARK_OUTPUTS_DIR }}/pixelmatch_*.json
            ${{ env.BENCHMARK_OUTPUTS_DIR }}/pixelmatch_*.md
            pixelmatch_*_diff.png
